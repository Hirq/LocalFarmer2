@page "/addFarmhouse"
@inherits BasePage
@inject IMapper mapper
@inject IFarmhouseService FarmhouseService
@inject IJSRuntime JSRuntime
@inject IAlertService AlertService
@inject UserStateService UserStateService
@inject NavigationManager NavigationManager
@inject ValidateService ValidateService
@inject FileService FileService

<PageTitle>@loc["Farmhouse_Add_Farmhouse"] | @Globals.AppName</PageTitle>
@if (isLoading)
{
    <MudProgressCircular Class="m-4" Color="Color.Primary" />
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
}
else
{
    <AuthorizeView>
        <EditForm Model="farmhouseDto" OnValidSubmit="OnValidSubmit" Context="editForm">
            <DataAnnotationsValidator />
            <MudGrid>
                <MudItem xs="12">
                    <MudText Class="d-flex justify-center" Typo="Typo.h6">@loc["Farmhouse_Add_Farmhouse"]</MudText>
                    <MudPaper Class="pa-4">
                        <MudTextField T="String" Label="@loc["X_Name"]" @bind-Value="farmhouseDto.Name" @ref="farmhouseNameField" Required For="@(() => farmhouseDto.Name)" ErrorText="@loc["Validation_Required"]" />
                        <MudTextField T="String" Label="@loc["X_Description"]" @bind-Value="farmhouseDto.Description" />
                        <MudTextField T="String" Label="@loc["Farmhouse_Address"]" @bind-Value="farmhouseDto.Address" />
                        <MudTextField T="String" Label="@loc["Farmhouse_Phone"]" @bind-Value="farmhouseDto.Phone" />
                        <MudTextField T="String" Label="Email" @bind-Value="farmhouseDto.Email" For="@(() => farmhouseDto.Email)" ErrorText="@loc["ErrorEmailValid"]" />
                        <MudSelect T="string"
                                   Label="@loc["Farmhouse_Payment_Methods"]"
                                   MultiSelection="true"
                                   SelectAll="true"
                                   SelectAllText="@loc["X_Select_All"]"
                                   @ref="paymentMethodsField"
                                   SelectedValues="@selectedPayments"
                                   SelectedValuesChanged="OnSelectedPaymentsChanged"
                                   ToStringFunc="GetPaymentMethodLabelByKey">
                            @foreach (var method in PaymentMethodInfo.PaymentMethods)
                            {
                                <MudSelectItem T="string" Value="@method.PropertyName">@GetPaymentMethodLabel(method)</MudSelectItem>
                            }
                        </MudSelect>
                        @if (!string.IsNullOrEmpty(paymentMethodsError))
                        {
                            <MudText Color="Color.Error" Typo="Typo.caption">@paymentMethodsError</MudText>
                        }
                        <EditFile Name="@loc["Farmhouse_Photo"]" Model="@farmhouseDto" IsOpenPhoto=false />
                        <MudTextField Disabled Id="latitude_input" Label="@loc["Farmhouse_Latitude"]" @bind-Value="farmhouseDto.Latitude" @ref="latitudeField" Required Placeholder="Max 90" RequiredError="@loc["Validation_Required"]" />
                        <MudTextField Disabled Id="longitude_input" Label="@loc["Farmhouse_Longitude"]" @bind-Value="farmhouseDto.Longitude" @ref="longitudeField" Required Placeholder="Max 180" RequiredError="@loc["Validation_Required"]" />
                    </MudPaper>
                    <MudPaper Class="pa-4 mt-4">
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">@loc["X_Save"]</MudButton>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </EditForm>
        <div id="map" style="height: 400px;"></div>

    </AuthorizeView>
}

@code {
    private IJSObjectReference? module;
    private string? result;
    private string? latitude;
    private string? longitude;
    private AddFarmhouseDto farmhouseDto = new();
    private string paymentMethodsError = string.Empty;
    private HashSet<string> selectedPayments = new();
    private MudTextField<string> farmhouseNameField;
    private MudTextField<string> latitudeField;
    private MudTextField<string> longitudeField;
    private MudSelect<string> paymentMethodsField;

    protected override async Task LoadDataAsync()
    {
        if (!await EnsureLoggedInAsync())
        {
            return;
        }

        if (!await EnsureHasnotFarmhouseAsync())
        {
            return;
        }

        FileService.ClearVariables();
        PaymentMethodInfo.ApplyDefaults(farmhouseDto);
        SyncSelectedPaymentsFromModel();
    }

    protected override async Task OnParametersSetAsync()
    {
        if(HasError)
        {
            return;
        }

        module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/leafletmap.js");
        if (module != null)
        {
            result = await module.InvokeAsync<string>("setCoordinates", "map");
        }
    }

    private async void OnValidSubmit(EditContext context)
    {
        if (module != null)
        {
            latitude = await module.InvokeAsync<string>("getValueById", "latitude_input");
            longitude = await module.InvokeAsync<string>("getValueById", "longitude_input");
        }

        farmhouseDto.Latitude = latitude;
        farmhouseDto.Longitude = longitude;

        var fieldsToValidate = new List<FieldToValidate>
        {
            new FieldToValidate(latitudeField, farmhouseDto.Latitude),
            new FieldToValidate(longitudeField, farmhouseDto.Longitude),
            new FieldToValidate(paymentMethodsField, selectedPayments.Any() ? string.Join(",", selectedPayments) : string.Empty)
        };

        context.Validate();

        if (ValidateService.ValidateMudTextFields(fieldsToValidate))
        {
            return;
        }
        if (!PaymentMethodInfo.HasAnySelection(farmhouseDto))
        {
            paymentMethodsError = loc["Validation_Required"];
            StateHasChanged();
            return;
        }

        paymentMethodsError = string.Empty;

        farmhouseDto.IdUser = UserStateService.CurrentUser.IdUser;
        var idFarmhouse = await FarmhouseService.AddFarmhouse(farmhouseDto);
        UserStateService.CurrentUser.FarmhouseName = farmhouseDto.Name;
        UserStateService.CurrentUser.IdFarmhouse = idFarmhouse;
        AlertService.SetSuccessAlert($"{@loc["Alert_Successfully"]} {@loc["Alert_Add_Farmhouse"]} {farmhouseDto.Name}");

        NavigationManager.NavigateTo("/");
        _ = AlertService.ClearAlertAfterDelay();
    }

    private string GetPaymentMethodLabel(PaymentMethodDefinition method)
    {
        var localized = loc[method.LocalizationKey];
        return localized.ResourceNotFound ? method.FallbackLabel : localized.Value;
    }

    private string GetPaymentMethodLabelByKey(string propertyName)
    {
        var method = PaymentMethodInfo.PaymentMethods.FirstOrDefault(m => m.PropertyName == propertyName);
        return method == null ? propertyName : GetPaymentMethodLabel(method);
    }

    private Task OnSelectedPaymentsChanged(IEnumerable<string>? values)
    {
        selectedPayments = values != null
            ? new HashSet<string>(values)
            : new HashSet<string>();

        PaymentMethodInfo.ApplySelection(farmhouseDto, selectedPayments);
        paymentMethodsError = string.Empty;
        return Task.CompletedTask;
    }

    private void SyncSelectedPaymentsFromModel()
    {
        selectedPayments = PaymentMethodInfo.GetSelectedKeys(farmhouseDto).ToHashSet();
    }
}
@page "/chat"
@inherits BasePage
@inject NavigationManager NavigationManager
@inject UserStateService UserStateService
@inject IAccountService AccountService
@inject IChatMessageService ChatMessageService
@inject IAlertService AlertService
@inject IJSRuntime JSRuntime

@if (isLoading)
{
    <MudProgressCircular Class="m-4" Color="Color.Primary" />
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
}
else
{
    <div class="mud-table-toolbar titlePage">
        <MudText Typo="Typo.h6">Chat</MudText>
    </div>
    <MudGrid Class="m-0 w-100">
        <MudItem xs="12" sm="2">
            <MudPaper Class="d-flex mud-width-full flex-column chat-user-outer-container">
                <div class="chat-user-inner-scroll">
                @if(lastMessages.Any())
                {
                    @foreach (var dto in lastMessages)
                    {
                        <MudCard Class="@string.Join(" ", "m-1", "border-1", "chat-user", IsSelected(dto) ? "active-chat" : "")" @onclick="() => GoPriv(dto.IdUserSender == FromUserId ? dto.IdUserReceiver : dto.IdUserSender)">
                            <MudCardContent>
                                <MudText Typo="Typo.body2">@dto.UserName</MudText>
                                <MudText Typo="Typo.body2">@dto.FullName</MudText>
                            </MudCardContent>
                            <MudCardActions Class="card-action-extra">
                                <MudText Typo="Typo.body2" class="@((!dto.IsRead && dto.IdUserSender != FromUserId) ? "bold-text" : "")">@(!dto.IsLastMessageFromSender ? dto.FullName : loc["X_Me"]): @(dto.Message.Length > 20 ? dto.Message.Substring(0, 17) + "..." : dto.Message) </MudText>
                                <MudText Class="card-action-date">@dto.DateSent</MudText>
                            </MudCardActions>
                        </MudCard>
                    }
                }
                else
                {
                        <MudText Typo="Typo.body1">@loc["Chat_Without_Chats"] <MudLink Href="/farmhouses">@StringHelper.LowerFirst(@loc["X_Farmhouses"])</MudLink>@loc["Chat_Without_Chats2"]</MudText>
                }
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="10">
            <MudPaper Class="@string.Join(" ", "d-flex", "align-center", "justify-center", "mud-width-full", "h-100", !isVisible ? "invisible" : "")" id="chatMessagesPanel">
                <div class="panel panel-primary chat-message-container">
                    <div class="panel-heading top-bar">
                        <div class="col-md-8 col-xs-8">
                            <h3 class="panel-title">
                                @if (ToUser != null)
                                {
                                    @if (ToUser.UserName != null)
                                    {
                                        <b>@ToUser.UserName</b>
                                    }
                                    else
                                    {
                                        <b>@ToUser.FullName</b>
                                    }
                                }
                            </h3>
                        </div>
                    </div>
                    <MudPaper Class="chat-messages" id="mud-paper-chat-message">
                        <div class="panel-body msg_container_base">
                            @if (Messages != null && Messages.Count() > 0)
                            {
                                @foreach (var message in Messages)
                                {
                                    @if (message.IsSeparator == true)
                                    {
                                        <div class="message-container date">
                                            <div class="message-box received-message">
                                                <div>
                                                    @($"{message.DateSent:dd.MM}")
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        @if (message.IdUserSender == FromUserId)
                                        {
                                            <div class="message-container sent">
                                                <div class="message-box sent-message">
                                                    <p>@message.Message</p>
                                                    <p>@message.DateSent.ToShortTimeString()</p>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="message-container received">
                                                <div class="message-box received-message">
                                                    <p>@message.Message</p>
                                                    <p>@message.DateSent.ToShortTimeString()</p>
                                                </div>
                                            </div>
                                        }
                                    }
                                }
                            }
                        </div>
                    </MudPaper>

                    <!--CHAT USER BOX-->
                    <div class="footer">
                        <div class="input-group">
                            <input id="txtMessageInput" @bind="MessageText" type="text" class="form-control input-sm chat_input"
                                    placeholder="@loc["Chat_Write_Your_Message_Here"]">
                            <button id="txtMessageButton" class="btn btn-primary" @onclick="Send">@loc["Farmhouse_Send"]</button>
                        </div>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    public IJSObjectReference module { get; set; }
    private List<ApplicationUser> usersWithHistory = new List<ApplicationUser>();
    private List<ChatLastMessageDto> lastMessages = new List<ChatLastMessageDto>();

    private HubConnection hubConnection;
    public string ToUserId { get; set; }
    public UserDto ToUser { get; set; } = new UserDto();
    public string FromUserId { get; set; }
    public UserDto FromUser { get; set; } = new UserDto();
    public string MessageText { get; set; }
    public ChatMessageDto dto { get; set; }
    public List<ChatMessageDto> Messages { get; set; } = new List<ChatMessageDto>();
    private bool isVisible = false;
    private string selectedUserId { get; set; }
    private string lastMessageDisplayed { get; set; }

    protected override async Task LoadDataAsync()
    {
        if (!await EnsureLoggedInAsync())
        {
            return;
        }

        FromUserId = UserStateService.CurrentUser?.IdUser;
        await SetLeftMenu(FromUserId);

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
            .Build();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if(HasError)
        {
            return;
        }

        if (string.IsNullOrEmpty(UserStateService.CurrentUser.FullName))
        {
            return;
        }
        module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/chat.js");
        await module.InvokeVoidAsync("setScroll");
    }


    private async Task SetLeftMenu(string idCurrentUser)
    {
        var chats = await ChatMessageService.GetUserChats(idCurrentUser);

        var startI = chats.Where(x => x.User1Id != idCurrentUser).Select(x => x.User1Id);
        var startYou = chats.Where(x => x.User2Id != idCurrentUser).Select(x => x.User2Id);
        var usersIdsWithHistory = startI.Union(startYou).ToList();
        usersWithHistory = await AccountService.GetUsersByIds(usersIdsWithHistory);

        lastMessages = await ChatMessageService.GetLastChatMessages(idCurrentUser, usersIdsWithHistory);
    }

    async Task GoPriv(string idReceiver)
    {
        isVisible = true;
        selectedUserId = idReceiver;
        MessageText = string.Empty;
        Messages.Clear();
        ToUserId = idReceiver;
        var messageHistory = await ChatMessageService.GetChatMessages(FromUserId, ToUserId);

        foreach (var message in messageHistory)
        {
            Messages.Add(message);
        }

        ToUser = await AccountService.GetUserById(ToUserId);
        FromUser = await AccountService.GetUserById(FromUserId);

        // Mark existing unread messages from this user as read when opening the conversation
        await ChatMessageService.MarkConversationAsRead(FromUserId, ToUserId);

        hubConnection.Remove("ReceiveMessage");
        hubConnection.On<ChatMessageDto>("ReceiveMessage", async (message) =>
        {
            if (message.IdUserSender == FromUserId ||
            (message.IdUserReceiver == FromUserId && message.IdUserSender == ToUserId))
            {
                Messages.Add(message);
                await SetLeftMenu(FromUserId);
                StateHasChanged();
            }
        });
        if (hubConnection.State == HubConnectionState.Disconnected)
        {
            await hubConnection.StartAsync();
        }

        StateHasChanged();
        await module.InvokeVoidAsync("scrollOnBottomMessages");
    }

    public async Task Send()
    {
        ChatMessageDto message = new ChatMessageDto();
        message.IdUserReceiver = ToUserId;
        message.IdUserSender = FromUserId;
        message.Message = MessageText;

        try
        {
            var isTodaySeparatorUsed = false;
            var separators = Messages.Where(x => x.IsSeparator);
            foreach (var separator in separators)
            {
                @if (separator.DateSent == DateTime.Today)
                {
                    isTodaySeparatorUsed = true;
                }
            }

            @if (!isTodaySeparatorUsed)
            {
                ChatMessageDto separatorToday = new ChatMessageDto();
                separatorToday.Message = "Separator";
                separatorToday.DateSent = DateTime.Today;
                separatorToday.IsSeparator = true;

                Messages.Add(separatorToday);
            }

            await hubConnection.SendAsync("SendMessage", message);
        }
        catch (Exception ex)
        {
                throw new Exception("Chat - Send: " + ex);
        }

        MessageText = string.Empty;
    }

    private bool IsSelected(ChatLastMessageDto dto)
    {
        return selectedUserId == (dto.IdUserSender == FromUserId ? dto.IdUserReceiver : dto.IdUserSender);
    }
}